"use strict";function AntuaneChart(i){this.init(i),console.log(this)}AntuaneChart.prototype.helper={getRandomInt:function(i,o){return Math.floor(Math.random()*(o-i))+i},wrapText:function(i,o,t,n,e,a){for(var r=o.split("\n"),g=0;g<r.length;g++){for(var c="",f=r[g].split(" "),l=0;l<f.length;l++){var h=c+f[l]+" ",s=i.measureText(h),d=s.width;d>e?(i.fillText(c,t,n),c=f[l]+" ",n+=a):c=h}i.fillText(c,t,n),n+=a}},colorLuminance:function(i,o){i=String(i).replace(/[^0-9a-f]/gi,""),i.length<6&&(i=i[0]+i[0]+i[1]+i[1]+i[2]+i[2]),o=o||0;var t,n,e="#";for(n=0;3>n;n++)t=parseInt(i.substr(2*n,2),16),t=Math.round(Math.min(Math.max(0,t+t*o),255)).toString(16),e+=("00"+t).substr(t.length);return e},cloneObj:function(i){if(null==i||"object"!=typeof i)return i;var o=i.constructor();for(var t in i)i.hasOwnProperty(t)&&(o[t]=cloneObj(i[t]));return o},getObjById:function(i,o){for(var t=0;t<i.length;t++)if(i[t].id==o)return i[t];return null},trackTransforms:function(i){var o=document.createElementNS("http://www.w3.org/2000/svg","svg"),t=o.createSVGMatrix();i.getTransform=function(){return t};var n=[],e=i.save;i.save=function(){return n.push(t.translate(0,0)),e.call(i)};var a=i.restore;i.restore=function(){return t=n.pop(),a.call(i)};var r=i.scale;i.scale=function(o,n){return t=t.scaleNonUniform(o,n),r.call(i,o,n)};var g=i.rotate;i.rotate=function(o){return t=t.rotate(180*o/Math.PI),g.call(i,o)};var c=i.translate;i.translate=function(o,n){return t=t.translate(o,n),c.call(i,o,n)};var f=i.transform;i.transform=function(n,e,a,r,g,c){var l=o.createSVGMatrix();return l.a=n,l.b=e,l.c=a,l.d=r,l.e=g,l.f=c,t=t.multiply(l),f.call(i,n,e,a,r,g,c)};var l=i.setTransform;i.setTransform=function(o,n,e,a,r,g){return t.a=o,t.b=n,t.c=e,t.d=a,t.e=r,t.f=g,l.call(i,o,n,e,a,r,g)};var h=o.createSVGPoint();i.transformedPoint=function(i,o){return h.x=i,h.y=o,h.matrixTransform(t.inverse())}}},AntuaneChart.prototype.init=function(i){var o=this;if(this.canvas=document.getElementById(i.config.element),!this.canvas)throw"Element not found";this.context=this.canvas.getContext("2d"),this.context=this.canvas.getContext("2d"),o.helper.trackTransforms(this.context),i.config.autoSize&&(this.canvas.width=this.canvas.parentNode.clientWidth,this.canvas.height=this.canvas.parentNode.clientHeight);for(var t=[],n=[],e=0,a=0,r=0;r<i.diagrams.length;r++){for(var g={id:i.diagrams[r].id,x:0,y:0,cx:0,cy:0,text:i.diagrams[r].text,color:i.diagrams[r].color,bgColor:i.diagrams[r].bgColor,parents:[],children:[],virgin:!0,orphan:!0},c=0;c<i.links.length;c++)i.links[c].source==g.id&&(g.parents.push(i.links[c].parent),g.orphan=!1),i.links[c].parent==g.id&&(g.children.push(i.links[c].source),g.orphan=!1);t.push(g)}for(var f=function h(i,n){if(i.virgin){i.virgin=!1,i.y=n,a>n&&(a=n);for(var e=0;e<i.children.length;e++){var r=o.helper.getObjById(t,i.children[e]);h(r,n+1)}for(var e=0;e<i.parents.length;e++){var r=o.helper.getObjById(t,i.parents[e]);h(r,n-1)}}},r=0;r<t.length;r++)f(t[r],0);for(var r=0;r<t.length;r++){var l=o.helper.getObjById(n,t[r].y);null!=l?t[r].orphan||(l.count++,t[r].x=l.count,l.count>e&&(e=l.count)):t[r].orphan||(n.push({id:t[r].y,count:1}),t[r].x=1)}i.config.linesCount=n,i.config.columnsCount=e,i.config.columnLower=a,i.config.scaleFactor=1.1,i.config.zoomScale=0,i.config.moveX=0,i.config.moveY=0,this.config=i.config,this.diagrams=t,this.draw(),this.events()},AntuaneChart.prototype.zoom=function(i){var o=this;o.config.zoomScale+=i;var t=o.context.transformedPoint(o.canvas.width/2,o.canvas.height/2);this.context.translate(t.x,t.y);var n=Math.pow(o.config.scaleFactor,i);o.context.scale(n,n),o.context.translate(-t.x,-t.y),this.draw()},AntuaneChart.prototype.rezetZoom=function(){var i=this;i.zoom(-i.config.zoomScale),i.context.translate(-i.config.moveX,-i.config.moveY),i.config.zoomScale=0,i.config.moveX=0,i.config.moveY=0},AntuaneChart.prototype.events=function(){var i=this,o=i.canvas.width/2,t=i.canvas.height/2,n=!1,e=!1;i.canvas.addEventListener("mousedown",function(a){document.body.style.mozUserSelect=document.body.style.webkitUserSelect=document.body.style.userSelect="none",i.canvas.style.cursor="move",o=a.offsetX||a.pageX-i.canvas.offsetLeft,t=a.offsetY||a.pageY-i.canvas.offsetTop,n=i.context.transformedPoint(o,t),e=!1,a.returnValue=!1},!1),i.canvas.addEventListener("mousemove",function(a){if(o=a.offsetX||a.pageX-i.canvas.offsetLeft,t=a.offsetY||a.pageY-i.canvas.offsetTop,e=!0,n){var r=i.context.transformedPoint(o,t);i.context.translate(r.x-n.x,r.y-n.y),i.draw(),i.config.moveX+=r.x-n.x,i.config.moveY+=r.y-n.y}},!1),i.canvas.addEventListener("mouseup",function(o){n=null,i.canvas.style.cursor="default"},!1);var a=function(o){var t=o.wheelDelta?o.wheelDelta/300:o.detail?-o.detail:0;return i.zoom(t),o.preventDefault()&&!1};i.canvas.addEventListener("DOMMouseScroll",a,!1),i.canvas.addEventListener("mousewheel",a,!1)},AntuaneChart.prototype.draw=function(){var i=this,o=i.context.transformedPoint(0,0),t=i.context.transformedPoint(i.canvas.width,i.canvas.height);i.context.clearRect(o.x,o.y,t.x-o.x,t.y-o.y);var n=i.config.width+2*i.config.margin;0==i.config.columnsCount&&(i.config.columnsCount=parseInt(i.canvas.width/n));var e=i.config.columnsCount*n,a=parseInt(i.canvas.width)/2-e/2;i.context.rotate(2*Math.PI);for(var r=0,g=0;g<i.diagrams.length;g++)if(i.diagrams[g].orphan){var c=a+i.config.margin+parseInt(r%i.config.columnsCount)*(i.config.width+2*i.config.margin),f=i.config.margin+parseInt(r/i.config.columnsCount)*(i.config.height+2*i.config.margin),l=i.context;l.fillStyle=i.diagrams[g].bgColor,l.fillRect(c,f,i.config.width,i.config.height);var h=i.context;h.fillStyle=i.diagrams[g].color,h.font=i.config.fontSize+"px "+i.config.fontFamily,i.helper.wrapText(i.context,i.diagrams[g].text,c+i.config.padding,f+i.config.padding+i.config.fontSize,i.config.width-2*i.config.padding,i.config.fontSize+.2*i.config.fontSize),r++}var s=i.config.height+3*i.config.margin+parseInt((r-1)/i.config.columnsCount)*(i.config.height+2*i.config.margin);isNaN(s)&&(s=i.config.margin);for(var g=0;g<i.diagrams.length;g++)if(!i.diagrams[g].orphan){var d=i.helper.getObjById(i.config.linesCount,i.diagrams[g].y).count,m=e/d,c=a+m*i.diagrams[g].x+(m/2-i.config.width/2)-m,f=s+Math.abs(i.config.columnLower)*(i.config.height+2*i.config.margin)+i.diagrams[g].y*(i.config.height+2*i.config.margin);i.diagrams[g].left=c,i.diagrams[g].top=f}for(var g=0;g<i.diagrams.length;g++)if(!i.diagrams[g].orphan)for(var v=0;v<i.diagrams[g].parents.length;v++){var p=i.helper.getObjById(i.diagrams,i.diagrams[g].parents[v]),u=!1,w=!1,x=!1,y=!1,T=!1,W=!1,C=0,b=0;if(i.diagrams[g].id==p.id?W=!0:i.diagrams[g].y==p.y?i.diagrams[g].x-p.x==-1?x=!0:i.diagrams[g].x-p.x==1?y=!0:w=!0:i.diagrams[g].y<p.y?u=!0:i.diagrams[g].y-p.y>1&&(T=!0),W){var S=i.config.margin/2-i.config.margin/i.config.columnsCount*i.diagrams[g].x;isFinite(S)||(S=0);var P=i.context;i.context.setLineDash([0]),P.beginPath(),P.strokeStyle=i.config.lineColor||i.diagrams[g].bgColor,P.moveTo(p.left+i.config.width/2+-1*S+S,p.top+i.config.height),P.lineTo(p.left+i.config.width/2+-1*S+S,p.top+i.config.height+i.config.margin/2),P.lineTo(p.left+i.config.width/2+-1*S-S,p.top+i.config.height+i.config.margin/2),P.lineTo(p.left+i.config.width/2+-1*S-S,p.top+i.config.height+i.config.arrowWidth/2),P.lineWidth=i.config.lineWidth,P.stroke();var k=i.context;k.fillStyle=i.config.lineColor||i.diagrams[g].bgColor,k.beginPath(),k.moveTo(p.left+i.config.width/2+-1*S-S,p.top+i.config.height),k.lineTo(p.left+i.config.width/2-i.config.arrowWidth/2+-1*S-S,p.top+i.config.height+i.config.arrowWidth),k.lineTo(p.left+i.config.width/2+i.config.arrowWidth/2+-1*S-S,p.top+i.config.height+i.config.arrowWidth),k.fill()}else if(x){var P=i.context;i.context.setLineDash([0]),P.beginPath(),P.strokeStyle=i.config.lineColor||i.diagrams[g].bgColor,P.moveTo(i.diagrams[g].left+i.config.width/2,i.diagrams[g].top+i.config.height/2),P.lineTo(p.left-i.config.arrowWidth,p.top+i.config.height/2),P.lineWidth=i.config.lineWidth,P.stroke();var k=i.context;k.fillStyle=i.config.lineColor||i.diagrams[g].bgColor,k.beginPath(),k.moveTo(p.left,p.top+i.config.height/2),k.lineTo(p.left-i.config.arrowWidth,p.top+i.config.height/2-i.config.arrowWidth/2),k.lineTo(p.left-i.config.arrowWidth,p.top+i.config.height/2+i.config.arrowWidth/2),k.fill()}else if(y){var P=i.context;i.context.setLineDash([0]),P.beginPath(),P.strokeStyle=i.config.lineColor||i.diagrams[g].bgColor,P.moveTo(i.diagrams[g].left+i.config.width/2,i.diagrams[g].top+i.config.height/2),P.lineTo(p.left+i.config.width+i.config.arrowWidth,p.top+i.config.height/2),P.lineWidth=i.config.lineWidth,P.stroke();var k=i.context;k.fillStyle=i.config.lineColor||i.diagrams[g].bgColor,k.beginPath(),k.moveTo(p.left+i.config.width,p.top+i.config.height/2),k.lineTo(p.left+i.config.width+i.config.arrowWidth,p.top+i.config.height/2-i.config.arrowWidth/2),k.lineTo(p.left+i.config.width+i.config.arrowWidth,p.top+i.config.height/2+i.config.arrowWidth/2),k.fill()}else if(w){var S=i.config.margin/2-i.config.margin/i.config.columnsCount*i.diagrams[g].x;isFinite(S)||(S=0);var P=i.context;i.context.setLineDash([0]),P.beginPath(),P.strokeStyle=i.config.lineColor||i.diagrams[g].bgColor,P.moveTo(i.diagrams[g].left+i.config.width/2+-1*S,i.diagrams[g].top),P.lineTo(i.diagrams[g].left+i.config.width/2+-1*S,i.diagrams[g].top-i.config.margin+S),P.lineTo(p.left+i.config.width/2+-1*S,p.top-i.config.margin+S),P.lineTo(p.left+i.config.width/2+-1*S,p.top+i.config.margin-i.config.arrowWidth),P.lineWidth=i.config.lineWidth,P.stroke();var k=i.context;k.fillStyle=i.config.lineColor||i.diagrams[g].bgColor,k.beginPath(),k.moveTo(p.left+i.config.width/2-S,p.top),k.lineTo(p.left+i.config.width/2-i.config.arrowWidth/2-S,p.top-i.config.arrowWidth),k.lineTo(p.left+i.config.width/2+i.config.arrowWidth/2-S,p.top-i.config.arrowWidth),k.fill()}else if(u){var S=i.config.margin/2-i.config.margin/i.config.columnsCount*i.diagrams[g].x+(i.config.margin-(i.config.arrowWidth+2*i.config.lineWidth*b)),P=i.context;i.context.setLineDash([2*i.config.lineWidth]),P.beginPath(),P.strokeStyle=i.config.lineColor||i.diagrams[g].bgColor,P.moveTo(i.diagrams[g].left+i.config.width/2+S,i.diagrams[g].top+i.config.height/2+S),P.lineTo(i.diagrams[g].left+i.config.width+i.config.margin+S,i.diagrams[g].top+i.config.height/2+S),P.lineTo(i.diagrams[g].left+i.config.width+i.config.margin+S,p.top-i.config.margin+S),P.lineTo(p.left+i.config.width/2+S,p.top-i.config.margin+S),P.lineTo(p.left+i.config.width/2+S,p.top-i.config.arrowWidth+S),P.lineWidth=i.config.lineWidth,P.stroke();var k=i.context;k.fillStyle=i.config.lineColor||i.diagrams[g].bgColor,k.beginPath(),k.moveTo(p.left+i.config.width/2+S,p.top),k.lineTo(p.left+i.config.width/2-i.config.arrowWidth/2+S,p.top-i.config.arrowWidth),k.lineTo(p.left+i.config.width/2+i.config.arrowWidth/2+S,p.top-i.config.arrowWidth),k.fill()}else if(T){var S=i.config.margin/2-i.config.margin/i.config.columnsCount*i.diagrams[g].x+(i.config.margin-(i.config.arrowWidth+2*i.config.lineWidth*C));C++,isFinite(S)||(S=0);var P=i.context;i.context.setLineDash([2*i.config.lineWidth]),P.beginPath(),P.strokeStyle=i.config.lineColor||i.helper.colorLuminance(i.diagrams[g].bgColor,-.2),P.moveTo(i.diagrams[g].left+i.config.width/2+-1*S,i.diagrams[g].top),P.lineTo(i.diagrams[g].left+i.config.width/2+-1*S,i.diagrams[g].top-i.config.margin+S),P.lineTo(p.left+i.config.width/2+-1*S,i.diagrams[g].top-i.config.margin+S),P.lineTo(p.left+i.config.width/2+-1*S,p.top+i.config.height+i.config.margin+S),P.lineTo(p.left+i.config.width/2+-1*S,p.top+i.config.height+i.config.arrowWidth/2),P.lineWidth=i.config.lineWidth,P.stroke();var k=i.context;k.fillStyle=i.config.lineColor||i.helper.colorLuminance(i.diagrams[g].bgColor,-.2),k.beginPath(),k.moveTo(p.left+i.config.width/2+-1*S,p.top+i.config.height),k.lineTo(p.left+i.config.width/2-i.config.arrowWidth/2+-1*S,p.top+i.config.height+i.config.arrowWidth),k.lineTo(p.left+i.config.width/2+i.config.arrowWidth/2+-1*S,p.top+i.config.height+i.config.arrowWidth),k.fill()}else{var S=i.config.margin/2-i.config.margin/i.config.columnsCount*i.diagrams[g].x;isFinite(S)||(S=0);var P=i.context;i.context.setLineDash([0]),P.beginPath(),P.strokeStyle=i.config.lineColor||i.diagrams[g].bgColor,P.moveTo(i.diagrams[g].left+i.config.width/2+-1*S,i.diagrams[g].top),P.lineTo(i.diagrams[g].left+i.config.width/2+-1*S,i.diagrams[g].top-i.config.margin+S),P.lineTo(p.left+i.config.width/2+-1*S,p.top+i.config.height+i.config.margin+S),P.lineTo(p.left+i.config.width/2+-1*S,p.top+i.config.height+i.config.arrowWidth/2),P.lineWidth=i.config.lineWidth,P.stroke();var k=i.context;k.fillStyle=i.config.lineColor||i.diagrams[g].bgColor,k.beginPath(),k.moveTo(p.left+i.config.width/2+-1*S,p.top+i.config.height),k.lineTo(p.left+i.config.width/2-i.config.arrowWidth/2+-1*S,p.top+i.config.height+i.config.arrowWidth),k.lineTo(p.left+i.config.width/2+i.config.arrowWidth/2+-1*S,p.top+i.config.height+i.config.arrowWidth),k.fill()}}for(var g=0;g<i.diagrams.length;g++)if(!i.diagrams[g].orphan){var c=i.diagrams[g].left,f=i.diagrams[g].top,l=i.context;l.fillStyle=i.diagrams[g].bgColor,l.fillRect(c,f,i.config.width,i.config.height);var h=i.context;h.fillStyle=i.diagrams[g].color,h.font=i.config.fontSize+"px "+i.config.fontFamily,i.helper.wrapText(i.context,i.diagrams[g].text,c+i.config.padding,f+i.config.padding+i.config.fontSize,i.config.width-2*i.config.padding,i.config.fontSize+.2*i.config.fontSize)}};